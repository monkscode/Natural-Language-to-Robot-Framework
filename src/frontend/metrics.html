<!DOCTYPE html>
<html lang="en" data-theme="professional">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mark 1 - Workflow Metrics</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;800&family=Space+Grotesk:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <!-- Chart.js for Visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.5/dist/chart.umd.min.js"
        integrity="sha384-MY7MzGt1eo8yEmzMhq5OA4nmpW53GMFFJkybLBGnp9KKnz4YKarSqrHpEe+Th9qH"
        crossorigin="anonymous"></script>

    <!-- Import shared styles from main stylesheet -->
    <link rel="stylesheet" href="style.css?v=4.2">

    <style>
        /* --- METRICS PAGE SPECIFIC STYLES --- */

        /* Main container with padding for metrics page */
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Nav button for "Back to Runner" link (unique to metrics page) */
        .nav-btn {
            padding: 8px 16px;
            border: var(--border-width) solid var(--border-color);
            background: var(--bg-surface);
            color: var(--text-main);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        [data-theme="neobrutalism"] .nav-btn {
            border: 3px solid var(--border-color);
            border-radius: 0;
            box-shadow: 4px 4px 0 0 var(--text-main);
        }

        [data-theme="neobrutalism"] .nav-btn:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0 0 var(--text-main);
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: var(--bg-surface);
            border: var(--border-width) solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow-md);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .metric-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 800;
            font-family: var(--font-display);
            color: var(--text-main);
        }

        .metric-trend {
            font-size: 0.85rem;
            margin-top: 0.5rem;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .trend-up {
            color: var(--success);
        }

        .trend-down {
            color: var(--error);
        }

        /* Charts Section */
        .charts-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .chart-card {
            background: var(--bg-surface);
            border: var(--border-width) solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow-md);
            height: 400px;
            position: relative;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .chart-select {
            padding: 6px 12px;
            border: var(--border-width) solid var(--border-color);
            background: var(--bg-surface-secondary);
            color: var(--text-main);
            border-radius: var(--border-radius);
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            outline: none;
        }

        .chart-select:hover {
            background: var(--bg-surface);
        }

        [data-theme="neobrutalism"] .chart-select {
            border: 2px solid var(--border-color);
            border-radius: 0;
        }

        .chart-wrapper {
            position: relative;
            height: calc(100% - 3.5rem);
            width: 100%;
        }

        /* Data Table */
        .table-card {
            background: var(--bg-surface);
            border: var(--border-width) solid var(--border-color);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }

        .table-header {
            padding: 1.5rem;
            border-bottom: var(--border-width) solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 1rem 1.5rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background: var(--bg-surface-secondary);
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover {
            background: var(--bg-surface-secondary);
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            display: inline-block;
        }

        [data-theme="neobrutalism"] .status-badge {
            border: 2px solid #000;
            border-radius: 0;
        }

        .status-success {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
        }

        .status-fail {
            background: rgba(239, 68, 68, 0.15);
            color: var(--error);
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: 1fr 1fr;
            }

            .charts-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 640px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">
                <div class="logo-icon">M1</div>
                <div class="logo-text">METRICS</div>
            </div>
            <div class="controls">
                <a href="/" class="nav-btn">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                    Back to Runner
                </a>
                <!-- Theme Switcher -->
                <div class="theme-toggle-group" title="Change Theme">
                    <button class="control-btn active" data-theme="professional" title="Professional (Default)"
                        aria-label="Switch to Professional theme">
                        <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9">
                            </path>
                        </svg>
                    </button>
                    <button class="control-btn" data-theme="neobrutalism" title="Neobrutalism (Gen Z)"
                        aria-label="Switch to Neobrutalism theme">
                        <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                    </button>
                </div>

                <!-- Dark Mode Toggle -->
                <div class="mode-toggle">
                    <button class="control-btn" id="mode-btn" data-action="toggle-dark-mode" title="Toggle Dark Mode"
                        aria-label="Toggle dark mode">
                        <svg id="moon-icon" width="18" height="18" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z">
                            </path>
                        </svg>
                        <svg id="sun-icon" width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z">
                            </path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="main-container">
        <!-- SUMMARY CARDS (Based on AggregateMetricsResponse) -->
        <div class="dashboard-grid">
            <div class="metric-card">
                <div class="metric-label">Total Workflows</div>
                <div class="metric-value" id="total-workflows">-</div>
                <div class="metric-trend trend-up">
                    <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                    </svg>
                    <span>All Time</span>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Avg Success Rate</div>
                <div class="metric-value" id="success-rate">-</div>
                <div class="metric-trend" id="success-trend">
                    <!-- Trend icon populated by JS -->
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Total Spend (USD)</div>
                <div class="metric-value" id="total-cost">-</div>
                <div class="metric-trend trend-down">
                    <span>Platform Total</span>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Avg Execution Time</div>
                <div class="metric-value" id="avg-time">-</div>
                <div class="metric-trend">
                    <span>Per Workflow</span>
                </div>
            </div>
        </div>

        <!-- MERGED CHARTS -->
        <div class="charts-container">
            <div class="chart-card">
                <div class="chart-header">
                    <div class="metric-label">Performance & Analysis</div>
                    <select id="chart1-select" class="chart-select">
                        <!-- Primary Metrics -->
                        <option value="execution-llm">Execution Time & LLM Calls</option>
                        <option value="cost-trend">Cost Trend Over Time</option>
                        <option value="success-trend">Success Rate Trend</option>
                        <option value="multi-metric">Multi-Metric Comparison</option>
                        <option value="token-usage">Token Usage (Prompt vs Completion)</option>
                        <option value="cost-efficiency">Cost Efficiency ($/Element)</option>
                        <!-- Element & Performance -->
                        <option value="elements-bar">Elements Found (Bar)</option>
                        <option value="success-elements">Success vs Failed Elements</option>
                        <option value="element-efficiency">LLM Calls per Element</option>
                        <option value="performance-scatter">Time vs Cost Scatter</option>
                        <!-- Locator Strategy Analysis -->
                        <option value="fallback-depth">Locator Strategy Distribution</option>
                    </select>
                </div>
                <div class="chart-wrapper">
                    <canvas id="chart1"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-header">
                    <div class="metric-label">Cost & Advanced Analytics</div>
                    <select id="chart2-select" class="chart-select">
                        <!-- Cost Analysis -->
                        <option value="cost-breakdown">Cost Breakdown (Pie)</option>
                        <option value="cost-stacked">Cost Stack Over Time</option>
                        <option value="cost-comparison">Browser vs CrewAI</option>
                        <option value="domain-cost">Cost by Domain</option>
                        <!-- Advanced Analysis -->
                        <option value="llm-distribution">LLM Call Distribution</option>
                        <option value="workflow-radar">Workflow Metrics Radar</option>
                        <option value="domain-performance">Domain Performance</option>
                        <option value="time-distribution">Execution Time Distribution</option>
                    </select>
                </div>
                <div class="chart-wrapper">
                    <canvas id="chart2"></canvas>
                </div>
            </div>
        </div>

        <!-- DETAILED TABLE (Based on WorkflowMetricsResponse) -->
        <div class="table-card">
            <div class="table-header">
                <div style="font-weight: 700; font-size: 1.1rem;">Recent Executions</div>
                <div style="display: flex; gap: 0.75rem; align-items: center;">
                    <select id="time-filter" class="nav-btn"
                        style="padding: 4px 12px; font-size: 0.8rem; cursor: pointer;">
                        <option value="all">All Time</option>
                        <option value="30">Past 30 Days</option>
                        <option value="7">Past 7 Days</option>
                        <option value="1">Today</option>
                    </select>
                    <button class="nav-btn" style="padding: 4px 12px; font-size: 0.8rem;"
                        onclick="fetchMetrics()">Refresh</button>
                </div>
            </div>
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Status</th>
                            <th>Workflow ID</th>
                            <th>Timestamp</th>
                            <th>URL / Task</th>
                            <th>LLM Calls</th>
                            <th>Elements</th>
                            <th>Cost</th>
                            <th>Time</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        <!-- Rows populated by JS -->
                        <tr>
                            <td colspan="8" style="text-align:center; padding: 2rem;">Loading data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Import shared theme logic from main script -->
    <script src="script.js?v=4.3"></script>

    <!-- Import modular chart system -->
    <script src="metrics-charts.js?v=1.0"></script>

    <script>
        // --- METRICS PAGE SPECIFIC LOGIC ---

        // Cache for chart data - only used when re-rendering charts on theme change
        // Fresh data is still fetched on page load and manual refresh
        let cachedRuns = [];
        let allRuns = []; // Store all runs for filtering

        // --- DATE FORMATTING HELPER ---
        function formatDateForTooltip(dateStr) {
            const d = new Date(dateStr);
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            const hours = String(d.getHours()).padStart(2, '0');
            const minutes = String(d.getMinutes()).padStart(2, '0');
            const seconds = String(d.getSeconds()).padStart(2, '0');
            return `${month}/${day} ${hours}:${minutes}:${seconds}`;
        }

        // --- TIME FILTER LOGIC ---
        function filterRunsByDays(runs, days) {
            if (days === 'all' || !runs) return runs;

            const now = new Date();
            const cutoff = new Date(now.getTime() - (parseInt(days) * 24 * 60 * 60 * 1000));

            return runs.filter(run => new Date(run.timestamp) >= cutoff);
        }

        // --- AGGREGATE CALCULATION HELPER ---
        function calculateAggregates(runs) {
            return {
                total_workflows: runs.length,
                avg_success_rate: runs.length > 0
                    ? runs.reduce((acc, r) => acc + (r.success_rate || 0), 0) / runs.length * 100
                    : 0,
                total_cost: runs.reduce((acc, r) => acc + (r.total_cost || 0), 0),
                avg_execution_time: runs.length > 0
                    ? runs.reduce((acc, r) => acc + (r.execution_time || 0), 0) / runs.length
                    : 0
            };
        }

        function applyFilter() {
            const filterValue = document.getElementById('time-filter').value;
            const filteredRuns = filterRunsByDays(allRuns, filterValue);
            const agg = calculateAggregates(filteredRuns);
            renderDashboard(filteredRuns, agg);
        }

        // --- API CONNECTION ---
        async function fetchMetrics() {
            try {
                // Fetch real data from backend API
                const response = await fetch('/api/workflow-metrics/');
                const data = await response.json();

                const aggResponse = await fetch('/api/workflow-metrics/aggregate');
                const aggData = await aggResponse.json();

                // Store all runs for filtering
                allRuns = data || [];

                // Apply current filter
                const filterValue = document.getElementById('time-filter').value;
                const filteredRuns = filterRunsByDays(allRuns, filterValue);

                // Use API aggregate for 'all', otherwise calculate from filtered data
                const filteredAgg = filterValue === 'all' ? aggData : calculateAggregates(filteredRuns);

                renderDashboard(filteredRuns, filteredAgg);
            } catch (e) {
                console.error("Failed to load metrics", e);
                // Show "not enough data" message instead of mock data
                const emptyAggData = {
                    total_workflows: 0,
                    avg_success_rate: 0,
                    total_cost: 0,
                    avg_execution_time: 0,
                    date_range: { start: new Date().toISOString(), end: new Date().toISOString() }
                };
                renderDashboard([], emptyAggData);
            }
        }

        // --- RENDER LOGIC ---
        function renderDashboard(runs, agg) {
            // Cache runs for theme change re-renders (Comment #7)
            cachedRuns = runs || [];

            // 1. Update Summary Cards
            document.getElementById('total-workflows').textContent = agg.total_workflows;

            const succRate = agg.avg_success_rate.toFixed(1);
            document.getElementById('success-rate').textContent = succRate + '%';

            const trendEl = document.getElementById('success-trend');
            if (succRate > 80) {
                trendEl.innerHTML = `<span class="trend-up">▲ High</span> Reliability`;
            } else {
                trendEl.innerHTML = `<span class="trend-down">▼ Low</span> Reliability`;
            }

            document.getElementById('total-cost').textContent = '$' + agg.total_cost.toFixed(2);
            document.getElementById('avg-time').textContent = agg.avg_execution_time.toFixed(1) + 's';

            // 2. Render Table
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';

            if (!runs || runs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding: 2rem;">No workflow data available yet. Run some tests to see metrics!</td></tr>';
                renderCharts([]);
                return;
            }

            runs.forEach(run => {
                const statusClass = run.success_rate >= 1.0 ? 'status-success' : 'status-fail';
                const statusText = run.success_rate >= 1.0 ? 'PASS' : 'FAIL';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td><span style="font-family:var(--font-mono); font-size:0.85rem;">${run.workflow_id}</span></td>
                    <td>${new Date(run.timestamp).toLocaleString()}</td>
                    <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${run.url || 'N/A'}</td>
                    <td>${run.total_llm_calls}</td>
                    <td>${run.total_elements || 0}</td>
                    <td>$${run.total_cost.toFixed(4)}</td>
                    <td>${run.execution_time.toFixed(1)}s</td>
                `;
                tbody.appendChild(tr);
            });

            // 3. Render Charts using modular system
            window.metricsCharts.render(runs);
        }

        // Helper functions for chart placeholders
        function showChartPlaceholder(canvas, message) {
            const wrapper = canvas.parentElement;
            canvas.style.display = 'none';

            // Remove existing placeholder if any
            const existing = wrapper.querySelector('.chart-placeholder');
            if (existing) existing.remove();

            const placeholder = document.createElement('div');
            placeholder.className = 'chart-placeholder';
            placeholder.style.cssText = 'display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-secondary); font-size: 1rem; text-align: center;';
            placeholder.innerHTML = `
                <div>
                    <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="opacity: 0.5; margin-bottom: 0.5rem;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    <p>${message}</p>
                </div>
            `;
            wrapper.appendChild(placeholder);
        }

        function clearChartPlaceholder(canvas) {
            const wrapper = canvas.parentElement;
            const placeholder = wrapper.querySelector('.chart-placeholder');
            if (placeholder) placeholder.remove();
            canvas.style.display = 'block';
        }

        function updateChartColors() {
            // Re-render charts with cached data - no API call needed for theme changes
            // Fresh data is fetched on page load and manual refresh (Comment #7)
            if (cachedRuns.length > 0) {
                window.metricsCharts.updateColors();
            }
        }

        // Listen for theme/mode changes via custom events (Comment #2 - decoupled pattern)
        // This avoids fragile function overrides and doesn't depend on load order
        window.addEventListener('themechange', () => {
            updateChartColors();
        });

        window.addEventListener('modechange', () => {
            updateChartColors();
        });

        // Time filter change handler
        document.getElementById('time-filter').addEventListener('change', applyFilter);

        // Initialize chart dropdowns
        window.metricsCharts.initialize();

        // Initial Load
        fetchMetrics();
    </script>
</body>

</html>